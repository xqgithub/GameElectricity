package com.sn.gameelectricity.app.util;

import android.annotation.SuppressLint;
import android.content.ContentUris;
import android.content.Context;
import android.content.Intent;
import android.database.Cursor;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.net.Uri;
import android.os.Build;
import android.os.Environment;
import android.provider.DocumentsContract;
import android.provider.MediaStore;
import android.provider.OpenableColumns;
import android.text.TextUtils;

import androidx.core.content.FileProvider;

import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;

/**
 * Created by nickyang on 2018/3/21.
 */

public class FileProvider7 {

    public static Uri getUriForFile(Context context, File file) {
        Uri fileUri = null;
        if (Build.VERSION.SDK_INT >= 24) {
            fileUri = getUriForFile24(context, file);
        } else {
            fileUri = Uri.fromFile(file);
        }
        return fileUri;
    }

    private static Uri getUriForFile24(Context context, File file) {
        Uri fileUri = FileProvider.getUriForFile(context, context.getPackageName() + ".android7.fileprovider", file);

        return fileUri;
    }


    public static void setIntentData(Context context, Intent intent, String type, File file, boolean writeAble) {
        if (Build.VERSION.SDK_INT >= 24) {
            intent.setDataAndType(getUriForFile(context, file), type);
            intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
            if (writeAble) {
                intent.addFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION);
            }
        } else {
            intent.setDataAndType(Uri.fromFile(file), type);
        }
    }

    public static void setIntentData(Context context, Intent intent, File file, boolean writeAble) {
        if (Build.VERSION.SDK_INT >= 24) {
            intent.putExtra(Intent.EXTRA_STREAM, getUriForFile(context, file));
            intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
            if (writeAble) {
                intent.addFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION);
            }
        } else {
            intent.putExtra(Intent.EXTRA_STREAM, Uri.fromFile(file));
        }
    }

    public static void installApk(Context context, File apkFile) {
        Intent intent = new Intent(Intent.ACTION_VIEW);
        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        setIntentData(context, intent, "application/vnd.android.package-archive", apkFile, true);
        context.startActivity(intent);
        //Â¶ÇÊûú‰∏çÂä†ÔºåÊúÄÂêé‰∏ç‰ºöÊèêÁ§∫ÂÆåÊàê„ÄÅÊâìÂºÄ„ÄÇ
        android.os.Process.killProcess(android.os.Process.myPid());
    }

    public static FileInfo getFileInfoFormContentUri(Context context, Uri uri) {
        if (uri == null) {
            return null;
        }
        String scheme = uri.getScheme();
        if (scheme.equals("file")) {
            String filePath = uri.getPath();
            File file = new File(filePath);
            if (!file.exists()) return null;

            FileInfo fileInfo = new FileInfo();
            fileInfo.fullPath = file.getAbsolutePath();
            fileInfo.name = file.getName();
            fileInfo.size = file.length();
            return fileInfo;
        } else if (scheme.equals("content")) {
            Cursor cursor = context.getContentResolver().query(uri, null, null, null, null);
            if (null == cursor) {
                return null;
            }
            FileInfo file = new FileInfo();
            int nameIndex = cursor.getColumnIndex(OpenableColumns.DISPLAY_NAME);
            int sizeIndex = cursor.getColumnIndex(OpenableColumns.SIZE);
            if (cursor.moveToFirst()) {
                file.fullPath = uri.toString();
                file.name = cursor.getString(nameIndex);
                file.size = cursor.getLong(sizeIndex);
                cursor.close();
                if (TextUtils.isEmpty(file.name)) { //ÊúâÂèØËÉΩÂèñ‰∏çÂà∞Êñá‰ª∂ÂêçÂ≠ó
                    String filePath = getPath(context, uri);
                    if (!TextUtils.isEmpty(filePath)) {
                        File f = new File(filePath);
                        if (f.exists()) {
                            file.name = f.getName();
                        }
                    }
                }

                return file;
            }
        }
        return null;
    }

    public static class FileInfo {
        public String fullPath; // ÂÖ®Ë∑ØÂæÑÂíåÂêçÁß∞
        public String name;  //Êñá‰ª∂ÁöÑÂêçÂ≠óÔºå7.0‰∏äËé∑ÂèñÂàÜ‰∫´Êñá‰ª∂ÁöÑË∑ØÂæÑÊ≤°ÊúâÊÑè‰πâÔºåÂè™ËÉΩÈÄöËøáuriËÆøÈóÆÂà∞Êñá‰ª∂
        public long size;    //Êñá‰ª∂ÁöÑÂ§ßÂ∞è
    }

    /**
     * @param context ‰∏ä‰∏ãÊñáÂØπË±°
     * @param uri     ÂΩìÂâçÁõ∏ÂÜåÁÖßÁâáÁöÑUri
     * @return Ëß£ÊûêÂêéÁöÑUriÂØπÂ∫îÁöÑString
     */
    @SuppressLint("NewApi")
    public static String getPath(final Context context, final Uri uri) {
        return getPath(context, uri, true);
    }

    /**
     * @param context ‰∏ä‰∏ãÊñáÂØπË±°
     * @param uri     ÂΩìÂâçÁõ∏ÂÜåÁÖßÁâáÁöÑUri
     * @return Ëß£ÊûêÂêéÁöÑUriÂØπÂ∫îÁöÑString
     */
    @SuppressLint("NewApi")
    public static String getPath(final Context context, final Uri uri, boolean pathHeadEnable) {

        final boolean isKitKat = Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT;
        String pathHead = "file:///";
        // 1. DocumentProvider
        if (isKitKat && DocumentsContract.isDocumentUri(context, uri)) {
            // 1.1 ExternalStorageProvider
            if (isExternalStorageDocument(uri)) {
                final String docId = DocumentsContract.getDocumentId(uri);
                final String[] split = docId.split(":");
                final String type = split[0];
                if ("primary".equalsIgnoreCase(type)) {
                    return (pathHeadEnable ? pathHead : "") + Environment.getExternalStorageDirectory() + "/" + split[1];
                }
            }
            // 1.2 DownloadsProvider
            else if (isDownloadsDocument(uri)) {
                String id = DocumentsContract.getDocumentId(uri);
                if (id.startsWith("raw:")) {//vivo
                    return id.substring(4);
                }

                if (id.contains(":")) {
                    id = id.split(":")[1];
                }

                String[] contentUriPrefixesToTry = new String[]{
                        "content://downloads/public_downloads",
                        "content://downloads/my_downloads",
                        "content://downloads/all_downloads"
                };

                for (String contentUriPrefix : contentUriPrefixesToTry) {
                    Uri contentUri = ContentUris.withAppendedId(Uri.parse(contentUriPrefix), Long.valueOf(id));
                    try {
                        String path = getDataColumn(context, contentUri, null, null);
                        if (path != null) {
                            return (pathHeadEnable ? pathHead : "") + path;
                        }
                    } catch (Exception e) {
                    }
                }

                String fileName = FileUtil.getFileName(context, uri);
                File cacheDir = FileUtil.getDocumentCacheDir(context);
                File file = FileUtil.generateFileName(fileName, cacheDir);
                String destinationPath = null;
                if (file != null) {
                    destinationPath = file.getAbsolutePath();
                    FileUtil.saveFileFromUri(context, uri, destinationPath);
                }

                return destinationPath;
            }
            // 1.3 MediaProvider
            else if (isMediaDocument(uri)) {
                final String docId = DocumentsContract.getDocumentId(uri);
                final String[] split = docId.split(":");
                final String type = split[0];

                Uri contentUri = null;
                if ("image".equals(type)) {
                    contentUri = MediaStore.Images.Media.EXTERNAL_CONTENT_URI;
                } else if ("video".equals(type)) {
                    contentUri = MediaStore.Video.Media.EXTERNAL_CONTENT_URI;
                } else if ("audio".equals(type)) {
                    contentUri = MediaStore.Audio.Media.EXTERNAL_CONTENT_URI;
                } else if ("document".equals(type)) {
                    contentUri = MediaStore.Files.getContentUri("external");
                }

                final String selection = "_id=?";
                final String[] selectionArgs = new String[]{split[1]};

                return (pathHeadEnable ? pathHead : "") + getDataColumn(context, contentUri, selection, selectionArgs);
            }
        }
        // 2. MediaStore (and general)
        else if ("content".equalsIgnoreCase(uri.getScheme())) {
            if (isGooglePhotosUri(uri)) {//Âà§Êñ≠ÊòØÂê¶ÊòØgoogleÁõ∏ÂÜåÂõæÁâá
                return uri.getLastPathSegment();
            } else if (isGooglePlayPhotosUri(uri)) {//Âà§Êñ≠ÊòØÂê¶ÊòØGoogleÁõ∏ÂÜåÂõæÁâá
                return uri.toString();
            } else if ("com.tencent.mtt.fileprovider".equals(uri.getAuthority())) {//Âà§Êñ≠ÊòØÂê¶ÊòØtencent fileprovider
                //  Path: /QQBrowser/Android/data/com.tencent.mm/MicroMsg/Download/Êñ∞Âª∫ÊñáÊú¨ÊñáÊ°£.html
                return "/storage/emulated/0/" + uri.getPath().replace("/QQBrowser/", "");
            } else if ("com.ss.android.lark.common.fileprovider".equals(uri.getAuthority())) {
                return "/storage/emulated/0/" + uri.getPath().replace("/external_files/", "");
            } else if ("com.huawei.hidisk.fileprovider".equals(uri.getAuthority())) {//Âà§Êñ≠ÊòØÂê¶ÊòØ huawei fileprovider
                //  Path: /root/storage/emulated/0/Tencent/MicroMsg/Download/1_üì• ÈúÄÊ±ÇÊ±†(1).xlsx
                return uri.getPath().replace("/root", "");
            } else {//ÂÖ∂‰ªñÁ±ª‰ºº‰∫émediaËøôÊ†∑ÁöÑÂõæÁâáÔºåÂíåandroid4.4‰ª•‰∏ãËé∑ÂèñÂõæÁâápathÊñπÊ≥ïÁ±ª‰ºº
                return getFilePath_below19(context, uri);
            }
        }
        // 3. Âà§Êñ≠ÊòØÂê¶ÊòØÊñá‰ª∂ÂΩ¢Âºè File
        else if ("file".equalsIgnoreCase(uri.getScheme())) {
            return pathHead + uri.getPath();
        }
        return null;
    }

    /**
     * @param uri The Uri to check.
     * @return Whether the Uri authority is ExternalStorageProvider.
     */
    private static boolean isExternalStorageDocument(Uri uri) {
        return "com.android.externalstorage.documents".equals(uri.getAuthority());
    }

    /**
     * @param uri The Uri to check.
     * @return Whether the Uri authority is DownloadsProvider.
     */
    private static boolean isDownloadsDocument(Uri uri) {
        return "com.android.providers.downloads.documents".equals(uri.getAuthority());
    }

    /**
     * @param uri The Uri to check.
     * @return Whether the Uri authority is MediaProvider.
     */
    private static boolean isMediaDocument(Uri uri) {
        return "com.android.providers.media.documents".equals(uri.getAuthority());
    }

    /**
     * Âà§Êñ≠ÊòØÂê¶ÊòØGoogleÁõ∏ÂÜåÁöÑÂõæÁâáÔºåÁ±ª‰ºº‰∫écontent://com.google.android.apps.photos.content/...
     **/
    public static boolean isGooglePhotosUri(Uri uri) {
        return "com.google.android.apps.photos.content".equals(uri.getAuthority());
    }

    /**
     * Âà§Êñ≠ÊòØÂê¶ÊòØGoogleÁõ∏ÂÜåÁöÑÂõæÁâáÔºåÁ±ª‰ºº‰∫écontent://com.google.android.apps.photos.contentprovider/0/1/mediakey:/local%3A821abd2f-9f8c-4931-bbe9-a975d1f5fabc/ORIGINAL/NONE/1075342619
     **/
    public static boolean isGooglePlayPhotosUri(Uri uri) {
        return "com.google.android.apps.photos.contentprovider".equals(uri.getAuthority());
    }

    /**
     * GoogleÁõ∏ÂÜåÂõæÁâáËé∑ÂèñË∑ØÂæÑ
     **/
    public static String getImageUrlWithAuthority(Context context, Uri uri) {
        InputStream is = null;
        if (uri.getAuthority() != null) {
            try {
                is = context.getContentResolver().openInputStream(uri);
                Bitmap bmp = BitmapFactory.decodeStream(is);
                return writeToTempImageAndGetPathUri(context, bmp).toString();
            } catch (FileNotFoundException e) {
                e.printStackTrace();
            } finally {
                try {
                    is.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
        return null;
    }

    /**
     * Â∞ÜÂõæÁâáÊµÅËØªÂèñÂá∫Êù•‰øùÂ≠òÂà∞ÊâãÊú∫Êú¨Âú∞Áõ∏ÂÜå‰∏≠
     **/
    public static Uri writeToTempImageAndGetPathUri(Context inContext, Bitmap inImage) {
        ByteArrayOutputStream bytes = new ByteArrayOutputStream();
        inImage.compress(Bitmap.CompressFormat.JPEG, 100, bytes);
        String path = MediaStore.Images.Media.insertImage(inContext.getContentResolver(), inImage, "Title", null);
        return Uri.parse(path);
    }

    /**
     * Ëé∑ÂèñÂ∞è‰∫éapi19Êó∂Ëé∑ÂèñÁõ∏ÂÜå‰∏≠ÂõæÁâáÁúüÊ≠£ÁöÑuri
     * ÂØπ‰∫éË∑ØÂæÑÊòØÔºöcontent://media/external/images/media/33517ËøôÁßçÁöÑÔºåÈúÄË¶ÅËΩ¨Êàê/storage/emulated/0/DCIM/Camera/IMG_20160807_133403.jpgË∑ØÂæÑÔºå‰πüÊòØ‰ΩøÁî®ËøôÁßçÊñπÊ≥ï
     *
     * @param context
     * @param uri
     * @return
     */
    public static String getFilePath_below19(Context context, Uri uri) {
        //ËøôÈáåÂºÄÂßãÁöÑÁ¨¨‰∫åÈÉ®ÂàÜÔºåËé∑ÂèñÂõæÁâáÁöÑË∑ØÂæÑÔºö‰ΩéÁâàÊú¨ÁöÑÊòØÊ≤°ÈóÆÈ¢òÁöÑÔºå‰ΩÜÊòØsdk>19‰ºöËé∑Âèñ‰∏çÂà∞
        Cursor cursor = null;
        String path = "";
        try {
            String[] proj = {MediaStore.Images.Media.DATA};
            //Â•ΩÂÉèÊòØandroidÂ§öÂ™í‰ΩìÊï∞ÊçÆÂ∫ìÁöÑÂ∞ÅË£ÖÊé•Âè£ÔºåÂÖ∑‰ΩìÁöÑÁúãAndroidÊñáÊ°£
            cursor = context.getContentResolver().query(uri, proj, null, null, null);
            //Ëé∑ÂæóÁî®Êà∑ÈÄâÊã©ÁöÑÂõæÁâáÁöÑÁ¥¢ÂºïÂÄº
            int column_index = cursor.getColumnIndexOrThrow(MediaStore.Images.Media.DATA);
            //Â∞ÜÂÖâÊ†áÁßªËá≥ÂºÄÂ§¥ ÔºåËøô‰∏™ÂæàÈáçË¶ÅÔºå‰∏çÂ∞èÂøÉÂæàÂÆπÊòìÂºïËµ∑Ë∂äÁïå
            cursor.moveToFirst();
            //ÊúÄÂêéÊ†πÊçÆÁ¥¢ÂºïÂÄºËé∑ÂèñÂõæÁâáË∑ØÂæÑ   ÁªìÊûúÁ±ª‰ººÔºö/mnt/sdcard/DCIM/Camera/IMG_20151124_013332.jpg
            path = cursor.getString(column_index);
        } catch (Exception e) {

        } finally {
            if (cursor != null) {
                cursor.close();
            }
        }
        return path;
    }

    /**
     * Ëé∑ÂèñÊï∞ÊçÆÂ∫ìË°®‰∏≠ÁöÑ _data ÂàóÔºåÂç≥ËøîÂõûUriÂØπÂ∫îÁöÑÊñá‰ª∂Ë∑ØÂæÑ
     *
     * @return
     */
    private static String getDataColumn(Context context, Uri uri, String selection, String[] selectionArgs) {
        String path = null;

        String[] projection = new String[]{MediaStore.Images.Media.DATA};
        Cursor cursor = null;
        try {
            cursor = context.getContentResolver().query(uri, projection, selection, selectionArgs, null);
            if (cursor != null && cursor.moveToFirst()) {
                int columnIndex = cursor.getColumnIndexOrThrow(projection[0]);
                path = cursor.getString(columnIndex);
            }
        } catch (Exception e) {
            if (cursor != null) {
                cursor.close();
            }
        }
        return path;
    }

    /**
     * Ëé∑ÂèñËßÜÈ¢ëÁöÑÊó∂Èïø
     *
     * @param context
     * @param uri
     * @return
     */
    public static long getVideoDuration(Context context, Uri uri) {
        Cursor cursor = null;
        try {
            String[] projection = new String[]{MediaStore.Video.Media.DURATION};
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT && isMediaDocument(uri)) {
                String selection = "_id=?";
                String documentId = DocumentsContract.getDocumentId(uri);
                String[] selectionArgs = new String[]{documentId.split(":")[1]};
                cursor = context.getContentResolver().query(MediaStore.Video.Media.EXTERNAL_CONTENT_URI, projection, selection, selectionArgs, null);
            } else {
                cursor = context.getContentResolver().query(uri, projection, null, null, null);
            }

            if (cursor != null && cursor.moveToFirst()) {
                int columnIndex = cursor.getColumnIndexOrThrow(projection[0]);
                return cursor.getLong(columnIndex);
            }
        } catch (Exception e) {
            if (cursor != null) {
                cursor.close();
            }
        }
        return 0L;
    }

    public static String getFileProviderName(Context context) {
        return context.getPackageName() + ".provider";
    }
}
